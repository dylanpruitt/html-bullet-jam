<!DOCTYPE html>
<html>
    <head>
        <title>The Game</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
                cursor: none;
            }
        </style>
    </head>
    <body onload="startGame()">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="js/assets.js"></script>
        <script src="js/bullets.js"></script>
        <script src="js/weapons.js"></script>
        <script src="js/tiles.js"></script>
        <script src="js/map.js"></script>
        <script src="js/entity.js"></script>
        <script src="js/render.js"></script>
        <script src="js/game.js"></script>
        <script>
            let loadMap = (path) => {
                $.getJSON(path, function(data) {
                    console.log("data: " + data);
                    spawnX = data.spawnX;
                    player.x = spawnX;
                    spawnY = data.spawnY;
                    player.y = spawnY;
                    MAP_WIDTH = data.MAP_WIDTH;
                    MAP_HEIGHT = data.MAP_HEIGHT;
                    xOffset = Math.floor(spawnX / 240) * -240;
                    if (xOffset < 0 && xOffset < -(MAP_WIDTH * TILE_SIZE * SCALE - game.canvas.width) / 2) {
                        xOffset = -(MAP_WIDTH * TILE_SIZE * SCALE - game.canvas.width) / 2;
                    }
                    yOffset = Math.floor(spawnY / 240) * -240; 
                    if (yOffset < 0 && yOffset < -(MAP_HEIGHT * TILE_SIZE * SCALE - game.canvas.height) / 2) {
                        yOffset = -(MAP_HEIGHT * TILE_SIZE * SCALE - game.canvas.height) / 2;
                    }
                    tileArray = data.tiles;
                    totalImages = tileArray.length;
                    for (let i = 0; i < tileArray.length; i++) {
                        tileArray[i].image = new Image();
                        tileArray[i].image.addEventListener("load", function() {
                            imagesLoaded++;
                        }, false);
                        tileArray[i].image.src = tileArray[i].imagePath;
                    }
                    boundingBoxes = data.boxes;
                    entities = data.entities;
                    for (let i = 0; i < entities.length; i++) {
                        let index = getEntityConstructorIndexFromName(entities[i].name);
                        if (index !== -1) {
                            entities[i] = entityConstructors[index](entities[i].x, entities[i].y);
                        }
                    }
                });    
            }

            let transitionToMap = (newMapPath) => {
                // save map data
                // save player data
                game.paused = true;

                imagesLoaded = 0;
                loadMap(newMapPath);
                interval = setInterval(() => {
                    if (imagesLoaded < totalImages) {
                        console.log(" >> " + imagesLoaded + "/" + totalImages);
                        game.clear();
                        game.context.font = "bold 24px Arial";
                        game.context.fillText("LOADING " + imagesLoaded + "/" + totalImages, 5, 135);
                    } else {
                        clearInterval(interval);
                        game.paused = false;
                        drawMaskContext(game);
                    }
                }, 20);                
            }
        </script>
        <input id="map-file" type="file"></input><br>
    </body>
</html>