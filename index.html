<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
                cursor: none;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="bullets.js"></script>
        <script src="weapons.js"></script>
        <script src="entity.js"></script>
    </head>
    <body onload="startGame()">
        <script>
        let tileArray = [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1,
            2, 3, 3, 2, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1,
            2, 3, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1,
            1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 2, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1,
            1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1,
            1, 1, 1, 2, 3, 2, 1, 1, 2, 2, 1, 2, 3, 2, 1,
            1, 1, 2, 2, 3, 3, 2, 2, 3, 3, 2, 1, 2, 1, 1,
            1, 1, 1, 2, 2, 2, 1, 1, 2, 2, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 2, 1, 1, 1, 1, 1, 2, 2, 3, 3, 1, 1, 1,
            1, 1, 1, 1, 2, 2, 1, 2, 3, 3, 3, 2, 1, 1, 2,
            1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 2, 3,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3,
        ];
        let MAP_WIDTH = 15;
        let SCALE = 2;
        let player;
        let newX;
        let newY;
        let keys;
        function startGame() {
            player = playerConstructor(10, 120);
            myGameArea.start();
        }
        
        var myGameArea = {
            canvas : document.createElement("canvas"),
            start : function() {
                this.canvas.width = 480;
                this.canvas.height = 480;
                newX = player.x;
                newY = player.y;
                this.context = this.canvas.getContext("2d");
                this.context.scale(SCALE, SCALE);
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.frameNo = 0;
                this.interval = setInterval(updateGameArea, 20);
            },
        
            clear : function() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            },
            stop : function() {
                clearInterval(this.interval);
            }
        }
let xOffset = 0;
let yOffset = 0;

let updateEntity = (entity) => {
    ctx = myGameArea.context;
    ctx.drawImage(entity.image, 
        entity.x, 
        entity.y,
        entity.width, 
        entity.height);
}

let wolf = wolfConstructor(99, 99);
let wolf2 = wolfConstructor(50, 30);

let updateBullets = () => {
    ctx = myGameArea.context;
    for (let i = 0; i < bullets.length; i++) {
        if (bullets[i].framesActive < bullets[i].maxFramesActive) {
            ctx.drawImage(bullets[i].image, 
                bullets[i].x, 
                bullets[i].y,
                bullets[i].width, 
                bullets[i].height);
            bullets[i].update();    
        }
    }

    removeDeadBullets();
}

let removeDeadBullets = () => {
    let temp = [];
    for (let i = 0; i < bullets.length; i++) {
        if (bullets[i].framesActive < bullets[i].maxFramesActive) {
            temp.push(bullets[i]);   
        }
    }
    bullets = temp;
}

function updateGameArea() {
    myGameArea.clear();
    render(xOffset,yOffset);
    renderCrosshair();
    updateEntity(player);
    updateEntity(wolf);
    updateEntity(wolf2);
    player.update();
    wolf.update(player);
    wolf2.update(player);
    updateBullets();
}

            let render = function (xOffset, yOffset) {
                let ctx = myGameArea.context;
                for (let i = 0; i < MAP_WIDTH; i++) {
                    for (let j = 0; j < MAP_WIDTH; j++) {
                        let imagePath = "grass-tile-" + tileArray[j * MAP_WIDTH + i] + ".png";
                        let image = new Image();
                        image.src = imagePath;
                        ctx.drawImage(image, 
                            j * image.width + xOffset, 
                            i * image.height + yOffset,
                            image.width, 
                            image.height);
                    }
                }

                
            }

            let renderCrosshair = () => {
                let cursorDist = getCursorDistanceFromPlayer();
                let imagePath;

                if (cursorDist <= player.equippedWeapon.range) {
                    imagePath = "crosshair.png";
                } else {
                    imagePath = "crosshair_invalid.png";
                }

                let ctx = myGameArea.context;
                let image = new Image();
                image.src = imagePath;
                ctx.drawImage(image, 
                    newX, 
                    newY,
                    image.width, 
                    image.height);
            }

            let getCursorDistanceFromPlayer = () => {
                let xDist = player.x - newX;
                let yDist = player.y - newY;
                return Math.sqrt(Math.pow(xDist, 2) + Math.pow(yDist, 2));
            }
        
            function getCursorPosition(event) {
                const rect = myGameArea.canvas.getBoundingClientRect();
                const x = Math.floor((event.clientX - rect.left) / SCALE);
                const y = Math.floor((event.clientY - rect.top) / SCALE);
                newX = x;
                newY = y;
            }

            myGameArea.canvas.addEventListener("mousemove", function(e) {
                getCursorPosition(e);
            });
            myGameArea.canvas.addEventListener("click", function(e) {
                getCursorPosition(e);
                if (player.equippedWeapon.cooldownFrames == 0) {
                    player.equippedWeapon.onFire(newX, newY);
                }
            });

            $('html').keydown(function(e) {
                keys = (keys || []);
                keys[e.keyCode] = true;

                let A = 65, a = 97;
                let W = 87, w = 119;
                let S = 83, s = 115;
                let D = 68, d = 100;
            
                if (keys[A] || keys[a]) {
                    if (player.speedX > 1) {
                        player.speedX -= 0.7;
                    } else {
                        player.speedX -= 0.3;
                    }
                    if (player.speedX < player.speedCap * -1) {
                        player.speedX = player.speedCap * -1;
                    }
                }
                if (keys[D] || keys[d]) {
                    if (player.speedX < -1) {
                        player.speedX += 0.7;
                    } else {
                        player.speedX += 0.3;
                    }
                    if (player.speedX > player.speedCap) {
                        player.speedX = player.speedCap;
                    }
                }
                if (keys[W] || keys[w]) {
                    if (player.speedY > 1) {
                        player.speedY -= 0.7;
                    } else {
                        player.speedY -= 0.3;
                    }
                    if (player.speedY < player.speedCap * -1) {
                        player.speedY = player.speedCap * -1;
                    }
                }
                if (keys[S] || keys[s]) {
                    if (player.speedY < -1) {
                        player.speedY += 0.7;
                    } else {
                        player.speedY += 0.3;
                    }
                    if (player.speedY > player.speedCap) {
                        player.speedY = player.speedCap;
                    }
                }
            });

            document.addEventListener("keyup", function (e) {
                keys[e.keyCode] = false;
            });
        </script>        
    </body>
</html>