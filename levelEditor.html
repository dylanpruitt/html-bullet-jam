<html>
    <head>
        <title>The Game - Level Editor</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
                cursor: none;
            }
            div {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
            #tile-picker {
                position: absolute;
                top: 8px;
                left: 490px;
                overflow-y: auto;
            }
            .tile-selector {
                position: absolute;
            }
            #selection-info {
                position: absolute;
                top: 8px;
                left: 530px;
            }
            #selected-entity-info {
                position: absolute;
                top: 240px;
                left: 530px;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="js/bullets.js"></script>
        <script src="js/weapons.js"></script>
        <script src="js/tiles.js"></script>
        <script src="js/map.js"></script>
        <script src="js/entity.js"></script>
        <script src="js/render.js"></script>
        <script src="js/game.js"></script>
        <script>
            let selection = 0;
            let editorMode = "selection";
            let mouseLock = false;

            let setupEditor = () => {
                generateMap();
                game.start();
                setupTilePicker();
                clearInterval(game.interval);
                game.canvas.removeEventListener("click", fireWeapon);
                game.interval = setInterval(updateMap, 20);
            }

            let setupTilePicker = () => {
                $("#tile-picker").width("32px").height(game.canvas.height);
                for (let i = 0; i < tileset.length; i++) {
                    let tileSelector = $("<div></div>").width("20px").height("20px");
                    tileSelector.id = "tile-selector-" + i;
                    tileSelector.className = "tile-selector";
                    let tileImageSource = tileset[i]().image.src;
                    let tileImage = $("<img></img>").attr("src", tileImageSource).width("20px").height("20px");
                    tileImage.click(function () {
                        console.log("Selected tile " + i);
                        selection = i;
                    });
                    tileImage.appendTo(tileSelector);
                    tileSelector.appendTo("#tile-picker");
                }
            }

            let updateMap = () => {
                game.clear();
                if (game.frameNo == 50) {
                    drawMaskContext(game);
                    game.frameNo = 0;
                }
                render(game);
                renderCrosshair();
                updateMaskContext();
                renderEntities();
                if (mouseLock) {
                    game.context.font = "8px Arial";
                    game.context.fillText("MOUSE LOCK", 2, 235);
                }
            }

            renderCrosshair = () => {
                let imagePath = "images/crosshair.png";

                let ctx = game.context;
                let image = new Image();
                image.src = imagePath;
                ctx.drawImage(image, 
                    mouseX, 
                    mouseY,
                    image.width, 
                    image.height);
            }

            let renderEntities = () => {
                for (let i = 0; i < entities.length; i++) {
                    drawEntity(entities[i], game.context);
                }
            }

            updateMaskContext = () => {
                if (!mouseLock) {
                    let updateMask = false;
                    if (mouseX + xOffset > 160 && xOffset > (MAP_WIDTH * 16 - game.canvas.width) / 2) {
                        xOffset -= 2;
                        updateMask = true;
                    }
                    if (mouseY + yOffset > 160 && yOffset > (MAP_WIDTH * 16 - game.canvas.height) / 2) {
                        yOffset -= 2;
                        updateMask = true;
                    }
                    if (mouseX + xOffset < 80 && xOffset < 0) {
                        xOffset += 2;
                        updateMask = true;
                    }
                    if (mouseY + yOffset < 80 && yOffset < 0) {
                        yOffset += 2;
                        updateMask = true;
                    }
                    if (updateMask) {
                        drawMaskContext(game);
                    }
                }
                
            }

            let getTileFromCursor = () => {
                let index = getTileIndexFromCursor();
                return tileArray[index];
            }
            
            let getTileIndexFromCursor = () => {
                let x = Math.floor((mouseX - xOffset)  / 16);
                let y = Math.floor((mouseY - yOffset) / 16);
                let index = y * MAP_WIDTH + x;
                return index;
            }

            let enlargeMap = (newXSize, newYSize) => {
                let temp = [];

                for (let y = 0; y < MAP_HEIGHT; y++) {
                    for (let x = 0; x < MAP_WIDTH; x++) {
                        let index = y * MAP_WIDTH + x;
                        temp.push(tileArray[index]);
                    }
                    for (let x = MAP_WIDTH; x < newXSize; x++) {
                        let index = y * newXSize + x;
                        temp.push(emptyTile(x * 16, y * 16));
                    }
                }

                for (let y = MAP_HEIGHT; y < newYSize; y++) {
                    for (let x = 0; x < newXSize; x++) {
                        let index = y * newXSize + x;
                        temp.push(emptyTile(x * 16, y * 16));
                    }
                }

                tileArray = temp;
                MAP_WIDTH = newXSize;
                MAP_HEIGHT = newYSize;
            }

            let shrinkMap = (newXSize, newYSize) => {
                let temp = [];

                for (let y = 0; y < newYSize; y++) {
                    for (let x = 0; x < newXSize; x++) {
                        let index = y * MAP_WIDTH + x;
                        temp.push(tileArray[index]);
                    }
                }

                tileArray = temp;
                MAP_WIDTH = newXSize;
                MAP_HEIGHT = newYSize;
            }

            game.canvas.addEventListener("click", function(e) {
                getCursorPosition(e);
            
                let x = Math.floor((mouseX - xOffset) / 16) * 16;
                let y = Math.floor((mouseY - yOffset) / 16) * 16;

                if (editorMode === "selection") {
                    let selection = tileArray[getTileIndexFromCursor()];
                    let infoMessage = "SELECTED TILE:<br>X: " + selection.x + ", Y: " + selection.y + "<br>COLLIDABLE: " + selection.collidable;
                    $("#selection-info").html(infoMessage);

                    let entityIndex = getSelectedEntity();
                    if (entityIndex > -1) {
                        createEntitySelectionDIV(entityIndex);
                    }
                } else if (editorMode === "tileEdit") {
                    tileArray[getTileIndexFromCursor()] = tileset[selection](x, y);
                    drawMaskContext(game);
                } else if (editorMode === "entityEdit") {
                    x = mouseX - xOffset;
                    y = mouseY - yOffset;
                    entities.push(wolfConstructor(x, y));
                }
            });

            let createEntitySelectionDIV = (entityIndex) => {
                if (document.getElementById("selected-entity-info")) {
                    document.body.removeChild(document.getElementById("selected-entity-info"));
                }

                let entityDIV = document.createElement("div");
                entityDIV.id = "selected-entity-info";
                document.body.appendChild(entityDIV);

                let entityInfo = document.createElement("p");
                let entity = entities[entityIndex];
                entityInfo.innerHTML = entity.name + " @ " + entity.x + ", " + entity.y + "<br>Health: " + entity.health;
                entityDIV.appendChild(entityInfo);

                let deleteEntity = document.createElement("button");
                deleteEntity.innerHTML = "Delete entity";
                deleteEntity.onclick = function() { 
                    entities.splice(entityIndex, 1);
                    document.body.removeChild(document.getElementById("selected-entity-info"));
                };
                entityDIV.appendChild(deleteEntity);
            }

            let getSelectedEntity = () => {
                let NONE_SELECTED = -1;
                for (let i = 0; i < entities.length; i++) {
                    if (mouseX - xOffset >= entities[i].x && mouseX - xOffset <= entities[i].x + entities[i].width
                        && mouseY - yOffset >= entities[i].y && mouseY - yOffset <= entities[i].y + entities[i].height) {
                            return i;
                        }
                }
                return NONE_SELECTED;
            }

            $('html').keydown(function(e) {
                keys = (keys || []);
                keys[e.keyCode] = true;

                let M = 77, m = 109;

                if (keys[M] || keys[m]) {
                    mouseLock = !mouseLock;
                }
            });

            let setEditorMode = (mode) => {
                editorMode = mode;
            }
        </script>
    </head>
    <body onload="setupEditor()">
        <div id="tile-picker"></div><br>
        <button id="default-selector" onclick="setEditorMode('selection')">Selection Mode</button><nobr>
        </nobr><button id="tile-editor" onclick="setEditorMode('tileEdit')">Tile Edit Mode</button><nobr>
        </nobr><button id="entities-editor" onclick="setEditorMode('entityEdit')">Place Entity Mode</button>
        <p id="selection-info"></p>
    </body>
</html>