<html>
    <head>
        <title>The Game - Level Editor</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
                cursor: none;
            }
            div {
                border: 1px solid #d3d3d3;
                background-color: #f1f1f1;
            }
            #tile-picker {
                position: absolute;
                top: 8px;
                left: 490px;
                overflow-y: auto;
            }
            .tile-selector {
                position: absolute;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="js/tiles.js"></script>
        <script src="js/map.js"></script>
        <script src="js/entity.js"></script>
        <script src="js/render.js"></script>
        <script src="js/game.js"></script>
        <script>
            let selection = 0;

            let setupEditor = () => {
                generateMap();
                game.start();
                setupTilePicker();
                clearInterval(game.interval);
                game.canvas.removeEventListener("click", fireWeapon);
                game.interval = setInterval(updateMap, 20);
            }

            let setupTilePicker = () => {
                $("#tile-picker").width("32px").height(game.canvas.height);
                for (let i = 0; i < tileset.length; i++) {
                    let tileSelector = $("<div></div>").width("20px").height("20px");
                    tileSelector.id = "tile-selector-" + i;
                    tileSelector.className = "tile-selector";
                    let tileImageSource = tileset[i]().image.src;
                    let tileImage = $("<img></img>").attr("src", tileImageSource).width("20px").height("20px");
                    tileImage.click(function () {
                        console.log("Selected tile " + i);
                        selection = i;
                    });
                    tileImage.appendTo(tileSelector);
                    tileSelector.appendTo("#tile-picker");
                }
            }

            let updateMap = () => {
                game.clear();
                if (game.frameNo == 50) {
                    drawMaskContext(game);
                    game.frameNo = 0;
                }
                render(game);
                renderCrosshair();
                updateMaskContext();
            }

            renderCrosshair = () => {
                let imagePath = "images/crosshair.png";

                let ctx = game.context;
                let image = new Image();
                image.src = imagePath;
                ctx.drawImage(image, 
                    mouseX, 
                    mouseY,
                    image.width, 
                    image.height);
            }

            updateMaskContext = () => {
                let updateMask = false;
                if (mouseX + xOffset > 160 && xOffset > (MAP_WIDTH * 16 - game.canvas.width) / 2) {
                    xOffset -= 2;
                    updateMask = true;
                }
                if (mouseY + yOffset > 160 && yOffset > (MAP_WIDTH * 16 - game.canvas.height) / 2) {
                    yOffset -= 2;
                    updateMask = true;
                }
                if (mouseX + xOffset < 80 && xOffset < 0) {
                    xOffset += 2;
                    updateMask = true;
                }
                if (mouseY + yOffset < 80 && yOffset < 0) {
                    yOffset += 2;
                    updateMask = true;
                }
                if (updateMask) {
                    drawMaskContext(game);
                }
            }

            let getTileFromCursor = () => {
                let index = getTileIndexFromCursor();
                return tileArray[index];
            }
            
            let getTileIndexFromCursor = () => {
                let x = Math.floor((mouseX - xOffset)  / 16);
                let y = Math.floor((mouseY - yOffset) / 16);
                let index = y * MAP_WIDTH + x;
                return index;
            }

            game.canvas.addEventListener("click", function(e) {
                getCursorPosition(e);
                let x = Math.floor((mouseX - xOffset) / 16) * 16;
                let y = Math.floor((mouseY - yOffset) / 16) * 16;
                tileArray[getTileIndexFromCursor()] = tileset[selection](x, y);
                drawMaskContext(game);
            });
        </script>
    </head>
    <body onload="setupEditor()">
        <div id="tile-picker"></div>
    </body>
</html>